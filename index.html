<script>
const SECTIONS = [
  "SUMMARY OF EVENTS:",
  "KEY CONCERNS:",
  "REQUEST / PURPOSE:"
];

const MAX_CHARS = 500;
window.finalLines = [];

function splitSentences(text) {
  return text.match(/[^.!?]+[.!?]*/g)?.map(s => s.trim()).filter(Boolean) || [];
}

function showPreview() {
  const raw = document.getElementById("text").value.trim();
  const lines = raw.split("\n").map(l => l.trim()).filter(Boolean);

  let html = "";
  let usedChars = 0;
  window.finalLines = [];

  const addToPreview = (htmlChunk, plainTextChunk, itemForPdf) => {
    let remaining = MAX_CHARS - usedChars;
    if (remaining <= 0) return false;

    let chunkText = plainTextChunk;
    if (plainTextChunk.length > remaining) {
      chunkText = plainTextChunk.slice(0, remaining);
      htmlChunk = `<span class="${itemForPdf.heading ? "heading" : "sentence"}">${escapeHtml(chunkText)}</span>`;
    }

    html += htmlChunk;
    usedChars += chunkText.length;
    if (itemForPdf) window.finalLines.push({ ...itemForPdf, text: chunkText });

    return usedChars < MAX_CHARS;
  };

  for (const line of lines) {
    if (SECTIONS.includes(line)) {
      const ok = addToPreview(
        `<span class="heading"><strong>${escapeHtml(line)}</strong></span><br>`,
        line,
        { text: line, heading: true }
      );
      if (!ok) break;
    } else {
      const sentences = splitSentences(line);
      for (const sentence of sentences) {
        const ok = addToPreview(
          `<span class="sentence">&nbsp;&nbsp;&nbsp;&nbsp;${escapeHtml(sentence)}</span><br>`,
          sentence,
          { text: sentence, heading: false }
        );
        if (!ok) break;
      }
      if (usedChars >= MAX_CHARS) break;
    }
  }

  const fullPlain = lines.join("\n");
  if (fullPlain.length > usedChars) {
    html += `<em>— Preview limited to ${MAX_CHARS} characters —</em>`;
  }

  document.getElementById("preview").innerHTML = html;
}

function downloadPDF() {
  if (!window.finalLines || window.finalLines.length === 0) {
    alert("Generate preview first");
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let y = 20;

  window.finalLines.forEach(item => {
    doc.setFont("helvetica", item.heading ? "bold" : "normal");
    const x = item.heading ? 20 : 35;

    const wrapped = doc.splitTextToSize(item.text, 170);
    wrapped.forEach(line => {
      if (y > 280) {
        doc.addPage();
        y = 20;
      }
      doc.text(line, x, y);
      y += 8;
    });

    y += item.heading ? 6 : 4;
  });

  doc.save("statement.pdf");
}

// HTML escaping
function escapeHtml(str) {
  return str
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}
</script>

