<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Legal Statement Generator</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://gumroad.com/js/gumroad.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { 
  font-family: 'Inter', Arial, sans-serif; 
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height: 100vh;
  padding: 20px;
}
.container {
  max-width: 800px;
  margin: 0 auto;
  background: white;
  border-radius: 16px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  padding: 40px;
}
h1 {
  color: #667eea;
  text-align: center;
  margin-bottom: 10px;
  font-size: 28px;
}
.disclaimer {
  background: #fff3cd;
  border-left: 4px solid #ffc107;
  padding: 15px;
  margin-bottom: 25px;
  border-radius: 4px;
  font-size: 13px;
  line-height: 1.6;
}
.disclaimer strong {
  color: #856404;
}
.form-group {
  margin-bottom: 20px;
}
label {
  display: block;
  font-weight: 600;
  color: #333;
  margin-bottom: 8px;
  font-size: 14px;
}
input, textarea, select {
  width: 100%;
  padding: 12px 15px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 15px;
  font-family: 'Inter', Arial, sans-serif;
  transition: border-color 0.3s;
}
input:focus, textarea:focus, select:focus {
  outline: none;
  border-color: #667eea;
}
textarea {
  resize: vertical;
  min-height: 100px;
}
.btn {
  width: 100%;
  padding: 16px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
  margin-top: 10px;
}
.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
}
.btn:active {
  transform: translateY(0);
}
.btn-secondary {
  background: #6c757d;
}
.btn-secondary:hover {
  background: #5a6268;
}
.preview-box {
  background: #f8f9fa;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  padding: 25px;
  margin-top: 30px;
  display: none;
}
.preview-box.active {
  display: block;
}
.preview-title {
  font-weight: bold;
  font-size: 13px;
  color: #666;
  margin-bottom: 15px;
  text-transform: uppercase;
  letter-spacing: 1px;
}
.preview-content {
  line-height: 1.8;
  max-height: 500px;
  overflow-y: auto;
}
.preview-content .section-title {
  font-weight: bold;
  color: #333;
  margin-top: 15px;
  margin-bottom: 8px;
  font-size: 15px;
}
.preview-content .section-text {
  padding-left: 30px;
  color: #555;
  margin-bottom: 12px;
}
.access-info {
  background: #e3f2fd;
  border: 2px solid #2196f3;
  border-radius: 8px;
  padding: 20px;
  margin-top: 20px;
  text-align: center;
}
.access-info h3 {
  color: #1976d2;
  margin-bottom: 10px;
}
.access-info .time-remaining {
  font-size: 24px;
  font-weight: bold;
  color: #1976d2;
  margin: 10px 0;
}
.access-info p {
  font-size: 14px;
  color: #555;
  margin-top: 10px;
}
.paywall {
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  color: white;
  padding: 30px;
  border-radius: 8px;
  margin-top: 20px;
  text-align: center;
}
.paywall h3 {
  margin-bottom: 10px;
  font-size: 24px;
}
.paywall .price {
  font-size: 48px;
  font-weight: bold;
  margin: 15px 0;
}
.paywall .features {
  background: rgba(255,255,255,0.2);
  border-radius: 8px;
  padding: 20px;
  margin: 20px 0;
  text-align: left;
}
.paywall .features ul {
  list-style: none;
  padding: 0;
}
.paywall .features li {
  padding: 8px 0;
  font-size: 16px;
}
.paywall .features li:before {
  content: "‚úì ";
  font-weight: bold;
  margin-right: 8px;
}
.gumroad-btn {
  display: inline-block;
  background: white;
  color: #f5576c;
  padding: 16px 40px;
  border-radius: 8px;
  text-decoration: none;
  font-weight: 600;
  font-size: 18px;
  transition: transform 0.2s, box-shadow 0.2s;
  border: none;
  cursor: pointer;
}
.gumroad-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 8px 20px rgba(0,0,0,0.2);
}
.payment-note {
  font-size: 13px;
  margin-top: 20px;
  opacity: 0.9;
  line-height: 1.5;
}
.loading {
  text-align: center;
  color: #667eea;
  margin-top: 20px;
  display: none;
}
.loading.active {
  display: block;
}
.session-locked {
  background: #ffebee;
  border: 2px solid #f44336;
  border-radius: 8px;
  padding: 25px;
  text-align: center;
  margin-top: 20px;
  display: none;
}
.session-locked.active {
  display: block;
}
.session-locked h3 {
  color: #c62828;
  margin-bottom: 15px;
}
</style>
</head>
<body>
<div class="container">
  <h1>üìã AI Legal Statement Generator</h1>
  
  <div class="disclaimer">
    <strong>‚ö†Ô∏è IMPORTANT DISCLAIMER:</strong> This tool does not provide legal advice and does not represent the work of a licensed attorney. The generated statements are for organizational and communication purposes only. This is not a substitute for professional legal counsel. For legal matters, please consult with a qualified attorney in your jurisdiction.
  </div>
  
  <form id="statementForm" onsubmit="return false;">
    <div class="form-group">
      <label>üìù Your Full Legal Name</label>
      <input type="text" id="name" placeholder="Enter your full name">
    </div>
    
    <div class="form-group">
      <label>üìç State (Optional)</label>
      <input type="text" id="state" placeholder="e.g., New York">
    </div>
    
    <div class="form-group">
      <label>‚öñÔ∏è Type of Matter</label>
      <select id="matter">
        <option>Family Court</option>
        <option>Custody / Visitation</option>
        <option>Child Support</option>
        <option>Divorce</option>
        <option>Landlord / Tenant</option>
        <option>Civil Matter</option>
        <option>Other Legal Matter</option>
      </select>
    </div>
    
    <div class="form-group">
      <label>üë§ Who is this statement for?</label>
      <select id="recipient">
        <option>My Attorney</option>
        <option>The Court</option>
        <option>Both</option>
      </select>
    </div>
    
    <div class="form-group">
      <label>üìÖ Chronological Summary of Events (Facts Only)</label>
      <textarea id="facts" rows="5" placeholder="Describe the events in chronological order..."></textarea>
    </div>
    
    <div class="form-group">
      <label>‚ö†Ô∏è Key Concerns or Issues</label>
      <textarea id="concerns" rows="4" placeholder="What are your main concerns?"></textarea>
    </div>
    
    <div class="form-group">
      <label>üéØ What outcome or clarification are you requesting?</label>
      <textarea id="request" rows="3" placeholder="What do you want to achieve?"></textarea>
    </div>
    
    <button type="button" class="btn" onclick="generateStatement()">‚ú® Generate AI Statement</button>
  </form>
  
  <div class="loading" id="loading">
    <p>ü§ñ AI is polishing your statement...</p>
  </div>
  
  <div class="preview-box" id="previewBox">
    <div class="preview-title">üìÑ Your Complete Statement Preview</div>
    <div class="preview-content" id="previewContent"></div>
    <button class="btn btn-secondary" style="margin-top: 20px;" onclick="editStatement()">‚úèÔ∏è Edit Statement</button>
  </div>
  
  <div class="access-info" id="accessInfo" style="display:none;">
    <h3>‚è∞ Active Session</h3>
    <p>You can edit and regenerate this statement for:</p>
    <div class="time-remaining" id="timeRemaining">4:00:00</div>
    <p style="font-size: 12px; color: #666;">
      Need a different statement for another matter? Each unique statement requires a separate purchase.
    </p>
    <button class="btn" style="margin-top: 15px;" onclick="downloadFullPDF()">üì• Download PDF</button>
    <button class="btn btn-secondary" style="margin-top: 10px;" onclick="regenerateStatement()">üîÑ Regenerate Statement</button>
  </div>
  
  <div class="paywall" id="paywall" style="display:none;">
    <h3>üîì Unlock Your Statement</h3>
    <div class="price">$10</div>
    
    <div class="features">
      <ul>
        <li><strong>4 HOURS</strong> of unlimited edits & regenerations for THIS statement</li>
        <li>Download professional PDF format</li>
        <li>AI-polished formatting</li>
        <li>Edit and perfect your statement as many times as needed</li>
        <li>Secure payment via Gumroad</li>
      </ul>
    </div>
    
    <a class="gumroad-button gumroad-btn" href="https://lamotte2.gumroad.com/l/oxhttg?wanted=true" target="_blank" onclick="initiatePurchase()">
      üí≥ Purchase 4-Hour Access
    </a>
    
    <p class="payment-note">
      ‚úÖ Secure checkout via Gumroad<br>
      ‚úÖ Accepts PayPal, Credit Cards & more<br>
      ‚ö†Ô∏è Each unique statement requires a separate purchase
    </p>
  </div>
  
  <div class="session-locked" id="sessionLocked">
    <h3>‚è∞ Session Expired</h3>
    <p style="margin-bottom: 20px;">Your 4-hour access period has ended. To continue editing or generate a new statement, please purchase again.</p>
    <a class="gumroad-btn" href="https://lamotte2.gumroad.com/l/oxhttg" target="_blank">
      üí≥ Purchase New Access
    </a>
  </div>
</div>

<script>
let fullStatement = "";
let statementData = {};
let sessionId = null;
let expirationTime = null;
let timerInterval = null;

// Check for active session on load
window.addEventListener('load', function() {
  checkSession();
});

function checkSession() {
  const storedSessionId = localStorage.getItem('statementSessionId');
  const storedExpiration = localStorage.getItem('sessionExpiration');
  const storedStatement = localStorage.getItem('sessionStatement');
  const storedData = localStorage.getItem('sessionData');
  
  if (storedSessionId && storedExpiration) {
    const now = new Date().getTime();
    const expiration = parseInt(storedExpiration);
    
    if (now < expiration) {
      // Session is still valid
      sessionId = storedSessionId;
      expirationTime = expiration;
      fullStatement = storedStatement || "";
      statementData = storedData ? JSON.parse(storedData) : {};
      
      if (fullStatement) {
        displayPreview(fullStatement);
        showAccessInfo();
        startTimer();
      }
    } else {
      // Session expired
      clearSession();
      document.getElementById('sessionLocked').classList.add('active');
    }
  }
}

function initiatePurchase() {
  // Store current statement data for after purchase
  localStorage.setItem('pendingStatement', fullStatement);
  localStorage.setItem('pendingData', JSON.stringify(statementData));
  localStorage.setItem('purchaseInitiated', 'true');
}

// Listen for when user returns from Gumroad
window.addEventListener('focus', function() {
  if (localStorage.getItem('purchaseInitiated') === 'true') {
    // Give user a moment, then ask for license key
    setTimeout(function() {
      showLicenseKeyPrompt();
      localStorage.removeItem('purchaseInitiated');
    }, 1000);
  }
});

function showLicenseKeyPrompt() {
  const licenseKey = prompt("Welcome back! Please enter the license key from your Gumroad purchase email to activate your 4-hour access:");
  if (licenseKey && licenseKey.trim().length > 0) {
    verifyLicenseKey(licenseKey.trim());
  }
}

async function verifyLicenseKey(licenseKey) {
  // Show loading
  alert("üîÑ Verifying your purchase...");
  
  try {
    const response = await fetch("/api/verify-purchase", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        license_key: licenseKey,
        product_permalink: "oxhttg"
      })
    });
    
    const data = await response.json();
    
    if (data.verified) {
      activateSession(licenseKey);
    } else {
      alert("‚ùå Invalid license key. Please check your Gumroad email and try again. The license key should be in your purchase confirmation email.");
      // Ask again
      setTimeout(showLicenseKeyPrompt, 500);
    }
  } catch (error) {
    console.error("Verification error:", error);
    alert("‚ö†Ô∏è Verification failed. Please check your internet connection and try again.");
    setTimeout(showLicenseKeyPrompt, 500);
  }
}

function activateSession(licenseKey) {
  // Generate unique session ID using license key
  sessionId = 'session_' + licenseKey + '_' + Date.now();
  
  // Set 4-hour expiration
  const now = new Date().getTime();
  expirationTime = now + (4 * 60 * 60 * 1000); // 4 hours in milliseconds
  
  // Store session
  localStorage.setItem('statementSessionId', sessionId);
  localStorage.setItem('sessionExpiration', expirationTime.toString());
  
  // Restore statement
  fullStatement = localStorage.getItem('pendingStatement') || fullStatement;
  const pendingData = localStorage.getItem('pendingData');
  if (pendingData) {
    statementData = JSON.parse(pendingData);
    restoreFormData();
  }
  
  localStorage.setItem('sessionStatement', fullStatement);
  localStorage.setItem('sessionData', JSON.stringify(statementData));
  
  // Show access info
  document.getElementById('paywall').style.display = 'none';
  showAccessInfo();
  startTimer();
  
  alert("‚úÖ Your 4-hour access is now active! You can edit and regenerate this statement as many times as needed.");
}

function showAccessInfo() {
  document.getElementById('accessInfo').style.display = 'block';
}

function startTimer() {
  if (timerInterval) clearInterval(timerInterval);
  
  timerInterval = setInterval(function() {
    const now = new Date().getTime();
    const remaining = expirationTime - now;
    
    if (remaining <= 0) {
      clearInterval(timerInterval);
      sessionExpired();
      return;
    }
    
    const hours = Math.floor(remaining / (1000 * 60 * 60));
    const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
    
    document.getElementById('timeRemaining').textContent = 
      `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  }, 1000);
}

function sessionExpired() {
  clearSession();
  document.getElementById('accessInfo').style.display = 'none';
  document.getElementById('previewBox').classList.remove('active');
  document.getElementById('sessionLocked').classList.add('active');
  alert("‚è∞ Your 4-hour access has expired. Purchase again to create or edit statements.");
}

function clearSession() {
  localStorage.removeItem('statementSessionId');
  localStorage.removeItem('sessionExpiration');
  localStorage.removeItem('sessionStatement');
  localStorage.removeItem('sessionData');
  sessionId = null;
  expirationTime = null;
  if (timerInterval) clearInterval(timerInterval);
}

function restoreFormData() {
  if (statementData.name) document.getElementById('name').value = statementData.name;
  if (statementData.state) document.getElementById('state').value = statementData.state;
  if (statementData.matter) document.getElementById('matter').value = statementData.matter;
  if (statementData.recipient) document.getElementById('recipient').value = statementData.recipient;
  if (statementData.facts) document.getElementById('facts').value = statementData.facts;
  if (statementData.concerns) document.getElementById('concerns').value = statementData.concerns;
  if (statementData.request) document.getElementById('request').value = statementData.request;
}

function editStatement() {
  // Just scroll back up to form - they can edit and regenerate
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

async function generateStatement() {
  const name = document.getElementById("name").value.trim() || "[Your Name]";
  const state = document.getElementById("state").value.trim() || "the applicable jurisdiction";
  const matter = document.getElementById("matter").value;
  const recipient = document.getElementById("recipient").value;
  const facts = document.getElementById("facts").value.trim() || "[Summary of events]";
  const concerns = document.getElementById("concerns").value.trim() || "[Key concerns]";
  const request = document.getElementById("request").value.trim() || "[Requested outcome]";
  
  statementData = { name, state, matter, recipient, facts, concerns, request };
  
  const rawStatement = `
Name: ${name}
State: ${state}
Matter Type: ${matter}
Recipient: ${recipient}

SUMMARY OF EVENTS:
${facts}

KEY CONCERNS:
${concerns}

REQUEST / PURPOSE:
${request}
`;

  document.getElementById("loading").classList.add("active");
  document.getElementById("previewBox").classList.remove("active");
  document.getElementById("paywall").style.display = "none";
  
  try {
    const response = await fetch("/api/rewrite", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text: rawStatement })
    });
    
    if (!response.ok) {
      throw new Error("AI service unavailable");
    }
    
    const data = await response.json();
    let polishedText = data.result;
    
    fullStatement = polishedText + `\n\nRespectfully submitted,\n${name}\n_________________________\nDate: ${new Date().toLocaleDateString()}`;
    
    // Update session storage if active
    if (sessionId) {
      localStorage.setItem('sessionStatement', fullStatement);
      localStorage.setItem('sessionData', JSON.stringify(statementData));
    }
    
    displayPreview(fullStatement);
    
    if (sessionId) {
      showAccessInfo();
    } else {
      document.getElementById("paywall").style.display = "block";
    }
    
  } catch (error) {
    alert("Failed to generate statement. Please try again.");
    console.error(error);
  } finally {
    document.getElementById("loading").classList.remove("active");
  }
}

function regenerateStatement() {
  if (!sessionId) {
    alert("Please purchase access first");
    return;
  }
  generateStatement();
}

function displayPreview(text) {
  const lines = text.split('\n');
  let html = '';
  
  for (let line of lines) {
    line = line.trim();
    line = line.replace(/\*\*/g, '');
    if (!line) continue;
    
    const isHeading = (line.includes(':') && line.length < 50 && line.toUpperCase() === line) ||
                      line.includes('SUMMARY') || 
                      line.includes('CONCERNS') || 
                      line.includes('REQUEST') ||
                      line.includes('PURPOSE');
    
    if (isHeading) {
      html += `<div class="section-title">${escapeHtml(line)}</div>`;
    } else {
      html += `<div class="section-text">${escapeHtml(line)}</div>`;
    }
  }
  
  document.getElementById("previewContent").innerHTML = html;
  document.getElementById("previewBox").classList.add("active");
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function downloadFullPDF() {
  if (!sessionId) {
    alert("Please purchase access first");
    return;
  }
  
  if (!fullStatement) {
    alert("Please generate a statement first");
    return;
  }
  
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  const margin = 20;
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  const maxWidth = pageWidth - (margin * 2);
  const indent = 15;
  
  let y = margin;
  
  doc.setFont("helvetica", "bold");
  doc.setFontSize(16);
  doc.text("LEGAL STATEMENT", pageWidth / 2, y, { align: "center" });
  y += 15;
  
  doc.setFontSize(11);
  doc.setFont("helvetica", "normal");
  
  const cleanedStatement = fullStatement.replace(/\*\*/g, '');
  const lines = cleanedStatement.split('\n');
  
  for (let line of lines) {
    line = line.trim();
    if (!line) {
      y += 6;
      continue;
    }
    
    const isHeading = (line.includes(':') && line.length < 50 && line.toUpperCase() === line) ||
                      line.includes('SUMMARY') || 
                      line.includes('CONCERNS') || 
                      line.includes('REQUEST') ||
                      line.includes('PURPOSE') ||
                      line.includes('Respectfully');
    
    if (y > pageHeight - margin - 20) {
      doc.addPage();
      y = margin;
    }
    
    if (isHeading) {
      y += 4;
      doc.setFont("helvetica", "bold");
      const wrappedHeading = doc.splitTextToSize(line, maxWidth);
      doc.text(wrappedHeading, margin, y);
      y += wrappedHeading.length * 7;
      doc.setFont("helvetica", "normal");
      y += 3;
    } else {
      const wrappedText = doc.splitTextToSize(line, maxWidth - indent);
      for (let wrappedLine of wrappedText) {
        if (y > pageHeight - margin - 20) {
          doc.addPage();
          y = margin;
        }
        doc.text(wrappedLine, margin + indent, y);
        y += 7;
      }
      y += 2;
    }
  }
  
  doc.save("legal-statement.pdf");
}
</script>
</body>
</html>
