<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AI Legal Statement Organizer - Format Test</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
body { font-family: 'Inter', Arial, sans-serif; margin: 0; padding: 20px; background: #f0f9ff; color: #333; }
.container { max-width: 750px; margin:auto; background:white; padding:30px 25px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,0.1); }
h2 { color:#1f6feb; font-weight:600; text-align:center; margin-bottom:20px; }
label { font-weight:600; display:block; margin-bottom:5px; }
input, textarea, select { width:100%; padding:12px; margin-bottom:20px; border-radius:8px; border:1px solid #ccc; font-size:15px; }
button { padding:14px; width:100%; background:#1f6feb; color:white; border:none; font-size:16px; border-radius:8px; cursor:pointer; }
button:hover { background:#155bcf; }
.output { white-space: pre-wrap; background:#f9f9f9; padding:15px; margin-top:20px; border-radius:8px; border:1px solid #e0e0e0; }
.subtitle { font-weight: bold; margin-top: 1em; }
.content { padding-left: 40px; margin-bottom: 1em; }
.paywall { background:#fff3cd; border-left:5px solid #ffeeba; border-radius:8px; padding:20px; margin-top:25px; }
</style>
</head>
<body>
<div class="container">
<h2>AI Legal Statement Organizer (Format Test)</h2>

<div>
<label>üìù Your Full Legal Name</label>
<input id="name">
<label>State (optional)</label>
<input id="state" placeholder="e.g., New York">
<label>Type of Matter</label>
<select id="matter">
  <option>Family Court</option>
  <option>Custody / Visitation</option>
  <option>Child Support</option>
  <option>Divorce</option>
  <option>Landlord / Tenant</option>
  <option>Civil Matter</option>
  <option>Other Legal Matter</option>
</select>
<label>Who is this statement for?</label>
<select id="recipient">
  <option>My Attorney</option>
  <option>The Court</option>
  <option>Both</option>
</select>
</div>

<div>
<label>Chronological Summary of Events (facts only)</label>
<textarea id="facts" rows="5"></textarea>
<label>Key Concerns or Issues</label>
<textarea id="concerns" rows="4"></textarea>
<label>What outcome or clarification are you requesting?</label>
<textarea id="request" rows="3"></textarea>
</div>

<button onclick="generate()">Generate AI Preview</button>
<div id="preview" class="output"></div>

<div id="paywall" class="paywall" style="display:none;">
  <p><strong>Unlock Full AI-Polished PDF</strong></p>
  <p>One-time fee: <strong>$10</strong></p>
  <p><a href="YOUR_PAYPAL_LINK" target="_blank">üëâ Pay to Unlock</a></p>
  <p>After payment, click below to download your PDF.</p>
  <button onclick="downloadPDF()">Download PDF</button>
</div>
</div>

<script>
const SECTIONS = ["SUMMARY OF EVENTS:", "KEY CONCERNS:", "REQUEST / PURPOSE:"];

async function rewriteStatement(text) {
  const response = await fetch("/api/rewrite", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ text })
  });
  if (!response.ok) {
    const err = await response.json().catch(() => ({}));
    throw new Error(err.error || "Failed to fetch AI");
  }
  const data = await response.json();
  return data.result;
}

function parseText(text) {
  const lines = text.split("\n");
  const parsed = [];
  let currentSubtitle = null;
  let currentContent = "";
  
  for (let line of lines) {
    line = line.trim();
    if (!line) continue;
    
    if (SECTIONS.some(section => line.includes(section))) {
      // Save previous content if exists
      if (currentSubtitle && currentContent) {
        parsed.push({ type: 'subtitle', text: currentSubtitle });
        parsed.push({ type: 'content', text: currentContent.trim() });
        currentContent = "";
      } else if (currentSubtitle) {
        parsed.push({ type: 'subtitle', text: currentSubtitle });
      }
      currentSubtitle = line;
    } else {
      currentContent += (currentContent ? " " : "") + line;
    }
  }
  
  // Don't forget the last section
  if (currentSubtitle) {
    parsed.push({ type: 'subtitle', text: currentSubtitle });
    if (currentContent) {
      parsed.push({ type: 'content', text: currentContent.trim() });
    }
  }
  
  return parsed;
}

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

async function generate(){
  const name = document.getElementById("name").value || "[Name]";
  const state = document.getElementById("state").value || "the applicable jurisdiction";
  const matter = document.getElementById("matter").value;
  const recipient = document.getElementById("recipient").value;
  const facts = document.getElementById("facts").value || "[Summary of events]";
  const concerns = document.getElementById("concerns").value || "[Key concerns]";
  const request = document.getElementById("request").value || "[Requested outcome]";

  const rawText = `
Name: ${name}
State: ${state}
Matter Type: ${matter}
Recipient: ${recipient}

SUMMARY OF EVENTS:
${facts}

KEY CONCERNS:
${concerns}

REQUEST / PURPOSE:
${request}
`;

  try {
    const polishedText = await rewriteStatement(rawText);

    window.finalText = polishedText + `

Respectfully submitted,
${name}
_________________________
Date: ${new Date().toLocaleDateString()}
`;

    // Parse and format preview with 500 char limit
    const parsedData = parseText(window.finalText);
    let html = "";
    let charCount = 0;
    let truncated = false;
    
    for (let item of parsedData) {
      if (item.type === 'subtitle') {
        html += `<div class="subtitle">${escapeHtml(item.text)}</div>`;
      } else {
        const remaining = 500 - charCount;
        if (remaining <= 0) {
          truncated = true;
          break;
        }
        
        const textToShow = item.text.length > remaining 
          ? item.text.substring(0, remaining) + "..."
          : item.text;
        
        html += `<div class="content">${escapeHtml(textToShow)}</div>`;
        charCount += textToShow.length;
        
        if (textToShow.length < item.text.length) {
          truncated = true;
          break;
        }
      }
    }
    
    if (truncated) {
      html += `<div style="margin-top:15px;font-style:italic;">--- Preview limited to 500 characters ---</div>`;
    }

    document.getElementById("preview").innerHTML = html;
    document.getElementById("paywall").style.display = "block";
  } catch (err) {
    alert("AI generation failed: " + err.message);
    console.error(err);
  }
}

function downloadPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: "pt", format: "letter" });
  const margin = 40;
  const indentWidth = 60;
  let y = margin;

  doc.setFontSize(16);
  doc.setFont(undefined,'bold');
  doc.text("STATEMENT FOR LEGAL COMMUNICATION", margin, y);
  y += 30;

  doc.setFontSize(12);
  doc.setFont(undefined,'normal');

  const pdfData = parseText(window.finalText);
  
  for (let item of pdfData) {
    if (item.type === 'subtitle') {
      if (y > 20) y += 5;
      if (y > 700) { doc.addPage(); y = margin; }
      
      doc.setFont(undefined, 'bold');
      doc.setFontSize(12);
      
      const lines = doc.splitTextToSize(item.text, 520);
      for (let line of lines) {
        doc.text(line, margin, y);
        y += 18;
      }
      doc.setFont(undefined, 'normal');
      y += 2;
      
    } else if (item.type === 'content') {
      doc.setFont(undefined, 'normal');
      doc.setFontSize(11);
      
      const lines = doc.splitTextToSize(item.text, 520 - indentWidth);
      for (let line of lines) {
        if (y > 700) { doc.addPage(); y = margin; }
        doc.text(line, margin + indentWidth, y);
        y += 18;
      }
      y += 3;
    }
  }

  doc.save("legal-statement.pdf");
}
</script>
</body>
</html>
