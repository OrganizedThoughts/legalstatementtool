<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Indented Sentences under Subtitles</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body { font-family: Arial, sans-serif; }
.output {
  background: #f0f0f0;
  padding: 12px;
  margin-top: 10px;
  white-space: normal;
}
.subtitle {
  font-weight: bold;
  margin-top: 1em;
}
.sentence {
  text-indent: 2em;
  margin: 0.5em 0;
}
</style>
</head>
<body>

<textarea id="text" rows="10" style="width:100%;">
SUMMARY OF EVENTS:
This is the first event. It continues here.

KEY CONCERNS:
Concern one. Concern two.

REQUEST / PURPOSE:
I request clarification.
</textarea>

<br><br>
<button onclick="showPreview()">Preview</button>
<button onclick="downloadPDF()">PDF</button>

<div id="preview" class="output"></div>

<script>
const SECTIONS = ["SUMMARY OF EVENTS:", "KEY CONCERNS:", "REQUEST / PURPOSE:"];
const MAX_CHARS = 500;
window.finalLines = [];

function splitSentences(text) {
  return text.match(/[^.!?]+[.!?]*/g)?.map(s => s.trim()).filter(Boolean) || [];
}

function escapeHtml(str) {
  return str.replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;").replaceAll("'", "&#039;");
}

function showPreview() {
  const raw = document.getElementById("text").value.trim();
  const lines = raw.split("\n").map(l => l.trim()).filter(Boolean);

  let html = "";
  let usedChars = 0;
  window.finalLines = [];
  let currentSection = false;

  for (const line of lines) {
    if (SECTIONS.includes(line)) {
      html += `<div class="subtitle">${escapeHtml(line)}</div>`;
      window.finalLines.push({ text: line, heading: true });
      currentSection = true;
      continue;
    }

    if (currentSection) {
      const sentences = splitSentences(line);
      for (const sentence of sentences) {
        if (usedChars >= MAX_CHARS) break;
        let chunk = sentence;
        if (chunk.length + usedChars > MAX_CHARS) {
          chunk = chunk.slice(0, MAX_CHARS - usedChars);
        }

        html += `<p class="sentence">${escapeHtml(chunk)}</p>`;
        window.finalLines.push({ text: chunk, heading: false });
        usedChars += chunk.length;
      }
    }
  }

  if (lines.join("\n").length > usedChars) {
    html += `<em>— Preview limited to ${MAX_CHARS} characters —</em>`;
  }

  document.getElementById("preview").innerHTML = html;
}

function downloadPDF() {
  if (!window.finalLines || window.finalLines.length === 0) {
    alert("Generate preview first");
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let y = 20;

  window.finalLines.forEach(item => {
    doc.setFont("helvetica", "normal");
    const x = item.heading ? 20 : 35; // indent sentences, subtitles normal

    const wrapped = doc.splitTextToSize(item.text, 170);
    wrapped.forEach(line => {
      if (y > 280) { doc.addPage(); y = 20; }
      doc.text(line, x, y);
      y += 8;
    });

    // Extra spacing after subtitles
    y += item.heading ? 6 : 4;
    if (item.heading) y += 4; // additional space between sections
  });

  doc.save("statement.pdf");
}
</script>

</body>
</html>
